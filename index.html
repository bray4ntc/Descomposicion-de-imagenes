<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio 1: Descomposici칩n de Im치genes con Quad Trees </title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        canvas {
            border: 1px solid black;
            display: block;
            margin: 10px auto;
        }
    </style>
</head>
<body class="container">
    <div class="text-center">
        <h1 class="my-4">Ejercicio 1: Descomposici칩n de Im치genes con Quad Trees</h1>
        <input type="file" id="imageLoader" name="imageLoader" class="form-control-file mb-3">
        <canvas id="imageCanvas"></canvas>
    </div>

    <!-- Bootstrap JS and jQuery (optional for Bootstrap) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        document.getElementById('imageLoader').addEventListener('change', handleImage, false);

        function handleImage(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('imageCanvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
        
                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    const grayscaleData = toGrayscale(imageData);
                    const quadTree = buildQuadTree(grayscaleData, 0, 0, img.width, img.height, 1000);
                    drawQuadTree(ctx, quadTree);
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
        
        function toGrayscale(imageData) {
            const data = imageData.data;
            const grayscaleData = [];
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                grayscaleData.push(avg);
            }
            return grayscaleData;
        }
        
        class QuadTreeNode {
            constructor(x, y, width, height, value = null) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.value = value;
                this.children = [];
            }
        }
        
        function buildQuadTree(data, x, y, width, height, threshold) {
            const node = new QuadTreeNode(x, y, width, height);
            if (isHomogeneous(data, x, y, width, height, threshold)) {
                node.value = calculateMean(data, x, y, width, height);
            } else {
                const halfWidth = Math.floor(width / 2);
                const halfHeight = Math.floor(height / 2);
                if (halfWidth > 0 && halfHeight > 0) {
                    node.children.push(buildQuadTree(data, x, y, halfWidth, halfHeight, threshold));
                    node.children.push(buildQuadTree(data, x + halfWidth, y, halfWidth, halfHeight, threshold));
                    node.children.push(buildQuadTree(data, x, y + halfHeight, halfWidth, halfHeight, threshold));
                    node.children.push(buildQuadTree(data, x + halfWidth, y + halfHeight, halfWidth, halfHeight, threshold));
                }
            }
            return node;
        }
        
        function isHomogeneous(data, x, y, width, height, threshold) {
            const mean = calculateMean(data, x, y, width, height);
            let error = 0;
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    const pixelValue = data[(y + i) * width + (x + j)];
                    error += (pixelValue - mean) ** 2;
                }
            }
            error /= (width * height);
            return error < threshold;
        }
        
        function calculateMean(data, x, y, width, height) {
            let sum = 0;
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    sum += data[(y + i) * width + (x + j)];
                }
            }
            return sum / (width * height);
        }
        
        function drawQuadTree(ctx, node) {
            if (node.value !== null) {
                ctx.strokeStyle = 'red';
                ctx.strokeRect(node.x, node.y, node.width, node.height);
            } else {
                for (let child of node.children) {
                    drawQuadTree(ctx, child);
                }
            }
        }
    </script>
</body>
</html>
